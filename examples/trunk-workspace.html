<!DOCTYPE HTML>
<html lang="en" class="ayu" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Workspace with Trunk - crane</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="A Nix library for building cargo projects.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('ayu')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Home</a></li><li class="chapter-item expanded affix "><a href="../CHANGELOG.html">Changelog</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../introduction/artifact-reuse.html"><strong aria-hidden="true">1.1.</strong> Artifact reuse</a></li><li class="chapter-item expanded "><a href="../introduction/sequential-builds.html"><strong aria-hidden="true">1.2.</strong> Sequential builds</a></li></ol></li><li class="chapter-item expanded "><a href="../getting-started.html"><strong aria-hidden="true">2.</strong> Getting started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/quick-start.html"><strong aria-hidden="true">2.1.</strong> Quick start</a></li><li class="chapter-item expanded "><a href="../examples/quick-start-simple.html"><strong aria-hidden="true">2.2.</strong> Quick start (simple)</a></li><li class="chapter-item expanded "><a href="../examples/quick-start-workspace.html"><strong aria-hidden="true">2.3.</strong> Quick start (workspace)</a></li><li class="chapter-item expanded "><a href="../examples/custom-toolchain.html"><strong aria-hidden="true">2.4.</strong> Custom toolchain</a></li><li class="chapter-item expanded "><a href="../examples/alt-registry.html"><strong aria-hidden="true">2.5.</strong> Alternative registry</a></li><li class="chapter-item expanded "><a href="../examples/build-std.html"><strong aria-hidden="true">2.6.</strong> Building standard library crates</a></li><li class="chapter-item expanded "><a href="../examples/cross-rust-overlay.html"><strong aria-hidden="true">2.7.</strong> Cross compiling</a></li><li class="chapter-item expanded "><a href="../examples/cross-musl.html"><strong aria-hidden="true">2.8.</strong> Cross compiling with musl</a></li><li class="chapter-item expanded "><a href="../examples/cross-windows.html"><strong aria-hidden="true">2.9.</strong> Cross compiling to windows</a></li><li class="chapter-item expanded "><a href="../examples/trunk.html"><strong aria-hidden="true">2.10.</strong> Building Trunk projects</a></li><li class="chapter-item expanded "><a href="../examples/trunk-workspace.html" class="active"><strong aria-hidden="true">2.11.</strong> Workspace with Trunk</a></li><li class="chapter-item expanded "><a href="../examples/end-to-end-testing.html"><strong aria-hidden="true">2.12.</strong> End-to-End Testing</a></li><li class="chapter-item expanded "><a href="../examples/sqlx.html"><strong aria-hidden="true">2.13.</strong> Building with SQLx</a></li></ol></li><li class="chapter-item expanded "><a href="../source-filtering.html"><strong aria-hidden="true">3.</strong> Source filtering</a></li><li class="chapter-item expanded "><a href="../local_development.html"><strong aria-hidden="true">4.</strong> Local development</a></li><li class="chapter-item expanded "><a href="../custom_cargo_commands.html"><strong aria-hidden="true">5.</strong> Custom cargo commands</a></li><li class="chapter-item expanded "><a href="../customizing_builds.html"><strong aria-hidden="true">6.</strong> Customizing builds</a></li><li class="chapter-item expanded "><a href="../overriding_derivations.html"><strong aria-hidden="true">7.</strong> Overriding derivations after the fact</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../API.html"><strong aria-hidden="true">8.</strong> API Reference</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../faq/faq.html"><strong aria-hidden="true">9.</strong> Troubleshooting/FAQ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../faq/custom-nixpkgs.html"><strong aria-hidden="true">9.1.</strong> Customizing nixpkgs and other inputs</a></li><li class="chapter-item expanded "><a href="../faq/ifd-error.html"><strong aria-hidden="true">9.2.</strong> IFD (import from derivation) errors</a></li><li class="chapter-item expanded "><a href="../faq/constant-rebuilds.html"><strong aria-hidden="true">9.3.</strong> Constantly rebuilding from scratch</a></li><li class="chapter-item expanded "><a href="../faq/rebuilds-with-different-toolchains.html"><strong aria-hidden="true">9.4.</strong> Crates being rebuilt when using different toolchains</a></li><li class="chapter-item expanded "><a href="../faq/rebuilds-with-proc-macros.html"><strong aria-hidden="true">9.5.</strong> Constantly rebuilding proc-macro dependencies dev mode</a></li><li class="chapter-item expanded "><a href="../faq/rebuilds-pyo3.html"><strong aria-hidden="true">9.6.</strong> Constantly rebuilding pyo3</a></li><li class="chapter-item expanded "><a href="../faq/rebuilds-bindgen.html"><strong aria-hidden="true">9.7.</strong> Constantly rebuilding bindgen</a></li><li class="chapter-item expanded "><a href="../faq/no-cargo-lock.html"><strong aria-hidden="true">9.8.</strong> Building upstream cargo crate with no Cargo.lock</a></li><li class="chapter-item expanded "><a href="../faq/patching-cargo-lock.html"><strong aria-hidden="true">9.9.</strong> Patching Cargo.lock during build</a></li><li class="chapter-item expanded "><a href="../faq/build-workspace-subset.html"><strong aria-hidden="true">9.10.</strong> Building a subset of a workspace</a></li><li class="chapter-item expanded "><a href="../faq/building-with-non-rust-includes.html"><strong aria-hidden="true">9.11.</strong> Trouble building when using include_str! (or including other non-rust files)</a></li><li class="chapter-item expanded "><a href="../faq/sandbox-unfriendly-build-scripts.html"><strong aria-hidden="true">9.12.</strong> Dealing with sandbox-unfriendly build scripts</a></li><li class="chapter-item expanded "><a href="../faq/workspace-not-at-source-root.html"><strong aria-hidden="true">9.13.</strong> Cargo.toml is not at the source root</a></li><li class="chapter-item expanded "><a href="../faq/invalid-metadata-files-for-crate.html"><strong aria-hidden="true">9.14.</strong> Found invalid metadata files for crate error</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../advanced/advanced.html"><strong aria-hidden="true">10.</strong> Advanced Techniques</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../advanced/overriding-function-behavior.html"><strong aria-hidden="true">10.1.</strong> Overriding function behavior</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">crane</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ipetkov/crane" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/ipetkov/crane/edit/master/docs/./examples/trunk-workspace.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p><a href="https://trunkrs.dev">Trunk</a> is a tool that allow you to build web apps using Rust and webassembly, including compiling scss, and distributing other assets.
It can be used in conjunction with any of Rust's web frameworks for the development of full stack web applications.</p>
<p>In this example we have a workspace with three members:</p>
<ul>
<li>client: a Yew application compiled using Trunk</li>
<li>server: a Axum server built using Cargo</li>
<li>shared: a library that contains types to be imported in both the client and server</li>
</ul>
<p>For a quick-start run the following in a fresh directory:</p>
<pre><code class="language-sh">nix flake init -t github:ipetkov/crane#trunk-workspace
</code></pre>
<p>Alternatively, if you have an existing project already, copy and paste the
following <code>flake.nix</code> and modify it to build your workspace's packages:</p>
<pre><code class="language-nix">{
  description = "Build a cargo project";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixpkgs-unstable";

    # The version of wasm-bindgen-cli needs to match the version in Cargo.lock
    # Update this to include the version you need
    nixpkgs-for-wasm-bindgen.url = "github:NixOS/nixpkgs/4e6868b1aa3766ab1de169922bb3826143941973";

    crane = {
      url = "github:ipetkov/crane";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    flake-utils.url = "github:numtide/flake-utils";

    rust-overlay = {
      url = "github:oxalica/rust-overlay";
      inputs = {
        nixpkgs.follows = "nixpkgs";
        flake-utils.follows = "flake-utils";
      };
    };
  };

  outputs = { self, nixpkgs, crane, flake-utils, rust-overlay, nixpkgs-for-wasm-bindgen, ... }:
    flake-utils.lib.eachDefaultSystem (system:
      let
        pkgs = import nixpkgs {
          inherit system;
          overlays = [ (import rust-overlay) ];
        };

        inherit (pkgs) lib;

        rustToolchain = pkgs.rust-bin.stable.latest.default.override {
          # Set the build targets supported by the toolchain,
          # wasm32-unknown-unknown is required for trunk.
          targets = [ "wasm32-unknown-unknown" ];
        };
        craneLib = ((crane.mkLib pkgs).overrideToolchain rustToolchain).overrideScope (_final: _prev: {
          # The version of wasm-bindgen-cli needs to match the version in Cargo.lock. You
          # can unpin this if your nixpkgs commit contains the appropriate wasm-bindgen-cli version
          inherit (import nixpkgs-for-wasm-bindgen { inherit system; }) wasm-bindgen-cli;
        });

        # When filtering sources, we want to allow assets other than .rs files
        src = lib.cleanSourceWith {
          src = ./.; # The original, unfiltered source
          filter = path: type:
            (lib.hasSuffix "\.html" path) ||
            (lib.hasSuffix "\.scss" path) ||
            # Example of a folder for images, icons, etc
            (lib.hasInfix "/assets/" path) ||
            # Default filter from crane (allow .rs files)
            (craneLib.filterCargoSources path type)
          ;
        };


        # Arguments to be used by both the client and the server
        # When building a workspace with crane, it's a good idea
        # to set "pname" and "version".
        commonArgs = {
          inherit src;
          pname = "trunk-workspace";
          version = "0.1.0";
          strictDeps = true;

          buildInputs = [
            # Add additional build inputs here
          ] ++ lib.optionals pkgs.stdenv.isDarwin [
            # Additional darwin specific inputs can be set here
            pkgs.libiconv
          ];
        };

        # Native packages

        nativeArgs = commonArgs // {
          pname = "trunk-workspace-native";
        };

        # Build *just* the cargo dependencies, so we can reuse
        # all of that work (e.g. via cachix) when running in CI
        cargoArtifacts = craneLib.buildDepsOnly nativeArgs;

        # Simple JSON API that can be queried by the client
        myServer = craneLib.buildPackage (nativeArgs // {
          inherit cargoArtifacts;
          # The server needs to know where the client's dist dir is to
          # serve it, so we pass it as an environment variable at build time
          CLIENT_DIST = myClient;
        });

        # Wasm packages

        # it's not possible to build the server on the
        # wasm32 target, so we only build the client.
        wasmArgs = commonArgs // {
          pname = "trunk-workspace-wasm";
          cargoExtraArgs = "--package=client";
          CARGO_BUILD_TARGET = "wasm32-unknown-unknown";
        };

        cargoArtifactsWasm = craneLib.buildDepsOnly (wasmArgs // {
          doCheck = false;
        });

        # Build the frontend of the application.
        # This derivation is a directory you can put on a webserver.
        myClient = craneLib.buildTrunkPackage (wasmArgs // {
          pname = "trunk-workspace-client";
          cargoArtifacts = cargoArtifactsWasm;
          trunkIndexPath = "client/index.html";
          # The version of wasm-bindgen-cli here must match the one from Cargo.lock.
          wasm-bindgen-cli = pkgs.wasm-bindgen-cli.override {
            version = "0.2.90";
            hash = "sha256-X8+DVX7dmKh7BgXqP7Fp0smhup5OO8eWEhn26ODYbkQ=";
            cargoHash = "sha256-ckJxAR20GuVGstzXzIj1M0WBFj5eJjrO2/DRMUK5dwM=";
          };
        });
      in
      {
        checks = {
          # Build the crate as part of `nix flake check` for convenience
          inherit myServer myClient;

          # Run clippy (and deny all warnings) on the crate source,
          # again, reusing the dependency artifacts from above.
          #
          # Note that this is done as a separate derivation so that
          # we can block the CI if there are issues here, but not
          # prevent downstream consumers from building our crate by itself.
          my-app-clippy = craneLib.cargoClippy (commonArgs // {
            inherit cargoArtifacts;
            cargoClippyExtraArgs = "--all-targets -- --deny warnings";
            # Here we don't care about serving the frontend
            CLIENT_DIST = "";
          });

          # Check formatting
          my-app-fmt = craneLib.cargoFmt commonArgs;
        };

        apps.default = flake-utils.lib.mkApp {
          name = "server";
          drv = myServer;
        };

        devShells.default = craneLib.devShell {
          # Inherit inputs from checks.
          checks = self.checks.${system};

          shellHook = ''
            export CLIENT_DIST=$PWD/client/dist;
          '';

          # Extra inputs can be added here; cargo and rustc are provided by default.
          packages = [
            pkgs.trunk
          ];
        };
      });
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../examples/trunk.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../examples/end-to-end-testing.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../examples/trunk.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../examples/end-to-end-testing.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
